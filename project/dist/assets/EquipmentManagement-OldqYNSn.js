import{r as d,s as l,j as t,C as R,A as ue,B as b,T as p,a as W,G as s,k as u,n as me,o as he,F as q,I as C,S as _,M as h,p as xe,q as fe,t as ge,v as G,w as H,x as pe,y as J,D as je,h as ve,i as ye,l as we}from"./index-z-43rxTh.js";import{d as be}from"./Delete-CbxsixXQ.js";import{d as qe,v as Ce}from"./CloudUpload-BGuNCpv-.js";const U={dimensions:"",weight:"",power_requirements:"",calibration_interval:"",safety_requirements:"",operating_conditions:""};function Ie(){const[K,V]=d.useState([]),[X,g]=d.useState(!0),[T,j]=d.useState(null),[Y,E]=d.useState(!1),[S,$]=d.useState(null),[y,Z]=d.useState(""),[D,ee]=d.useState(""),[L,te]=d.useState(""),[M,O]=d.useState(!1),[k,re]=d.useState([]),[ae,se]=d.useState([]),[a,c]=d.useState({name:"",category:"",description:"",manufacturer:"",model:"",quantity:1,image_url:"",detailed_specs:U,status:"operational",lab_id:""}),[ne,N]=d.useState([]);d.useEffect(()=>{ie()},[]);const ie=async()=>{try{const{data:{user:e}}=await l.auth.getUser();if(!e)throw new Error("User not authenticated");const r=e.id,{data:i,error:o}=await l.from("lab").select("id, name, status",{count:"exact"}).eq("manager_id",r);if(o)throw o;if(!i||i.length===0){N([]);return}const n=i.map(f=>f.id),{data:m,error:x}=await l.from("lab").select("id, name, location").in("id",n).order("name");if(x)throw x;N(m)}catch(e){j(e.message)}finally{g(!1)}};d.useEffect(()=>{A(),P().then(e=>re(e||[])),P(),le()},[]);const A=async()=>{try{g(!0);const{data:{user:e}}=await l.auth.getUser();if(!e)throw new Error("User not authenticated");const r=e.id,{data:i,error:o}=await l.from("lab").select("id").eq("manager_id",r);if(o)throw o;const n=i.map(F=>F.id),{data:m,error:x}=await l.from("equipment").select("id").in("lab_id",n);if(x)throw x;const f=m.map(F=>F.id),{data:I,error:w}=await l.from("equipment").select("*").in("id",f).order("name");if(w)throw w;V(I)}catch(e){j(e.message)}finally{g(!1)}},P=async()=>{try{g(!0);const{data:e,error:r}=await l.from("equipment_categories").select("*").order("name");if(r)throw r;return e?e.map(i=>i.name):[]}catch(e){j(e.message)}finally{g(!1)}},le=async()=>{try{const{data:e,error:r}=await l.from("users").select("id, email, role").order("created_at",{ascending:!1});if(r)throw r;se(e||[])}catch(e){j(e.message)}},B=async(e,r,i,o)=>{try{const{error:n}=await l.from("notifications").insert(ae.map(m=>({id:crypto.randomUUID(),user_id:m.id,created_by:e,title:r,message:i,type:o,read:!1,created_at:new Date().toISOString()})));if(n)throw n}catch(n){console.error("Error sending notifications:",n.message)}},oe=async e=>{try{const r=e.target.files?.[0];if(!r)return;O(!0);const i=r.name.split(".").pop(),n=`${`${Ce()}.${i}`}`,{error:m}=await l.storage.from("equipment-images").upload(n,r);if(m)throw m;const{data:{publicUrl:x}}=l.storage.from("equipment-images").getPublicUrl(n);c(f=>({...f,image_url:x}))}catch(r){j("Error uploading image: "+r.message)}finally{O(!1)}},Q=e=>{e?(c({name:e.name,category:e.category,description:e.description||"",manufacturer:e.manufacturer||"",model:e.model||"",quantity:1,image_url:e.image_url||"",detailed_specs:e.detailed_specs||U,status:e.status,lab_id:e.lab_id}),$(e)):(c({name:"",category:"",description:"",manufacturer:"",model:"",quantity:1,image_url:"",detailed_specs:U,status:"operational",lab_id:""}),$(null)),E(!0)},z=async e=>{e.preventDefault(),g(!0);try{if(S){const{error:r}=await l.from("equipment").update(a).eq("id",S.id);if(r)throw r}else{const{error:r}=await l.from("equipment").insert([a]);if(r)throw r;await B("System","New Equipment Added",`New equipment "${a.name}" has been added.`,"Equipment created")}E(!1),A()}catch(r){j(r.message)}finally{g(!1)}},v=(e,r)=>{c(i=>({...i,detailed_specs:{...i.detailed_specs,[e]:r}}))},de=K.filter(e=>{const r=e.name.toLowerCase().includes(y.toLowerCase())||e.description?.toLowerCase().includes(y.toLowerCase())||e.manufacturer?.toLowerCase().includes(y.toLowerCase())||e.model?.toLowerCase().includes(y.toLowerCase()),i=!D||e.category===D,o=!L||e.status===L;return r&&i&&o});if(X)return t.jsx(R,{});if(T)return t.jsx(ue,{severity:"error",children:T});async function ce(e,r){if(window.confirm("Are you sure you want to delete this equipment?"))try{const{data:o,error:n}=await l.from("equipment").select("status").eq("id",e).single();if(n)throw new Error(`Failed to fetch equipment details: ${n.message}`);if(!o)throw new Error("Equipment not found");const m={reserved:"This equipment is currently reserved and cannot be deleted.",maintenance:"This equipment is currently under maintenance and cannot be deleted.",out_of_order:"This equipment is out of order and cannot be deleted until resolved."},x=o.status;if(m[x])throw new Error(m[x]);const{data:f,error:I}=await l.from("reservations").select("*").eq("equipment_id",e).in("status",["pending","approved"]);if(I)throw new Error(`Failed to check reservations: ${I.message}`);if(f&&f.length>0)throw new Error("This equipment has active reservations and cannot be deleted.");const{error:w}=await l.from("equipment").delete().eq("id",e);if(w)throw new Error(`Failed to delete equipment: ${w.message}`);await B("System","Equipment Deleted",`Equipment: "${r}" has been deleted.`,"Equipment deleted"),A()}catch(o){let n=o.message||"An unexpected error occurred while deleting the equipment.";n.includes("active reservations")&&(n="This equipment has active reservations and cannot be deleted."),window.alert(n),console.error("Error:",o)}}return t.jsxs(b,{children:[t.jsxs(b,{sx:{display:"flex",justifyContent:"space-between",mb:2},children:[t.jsx(p,{variant:"h6",children:"Equipment Management"}),t.jsx(W,{variant:"contained",color:"primary",onClick:()=>Q(),children:"Add Equipment"})]}),t.jsxs(s,{container:!0,spacing:2,sx:{mb:3},children:[t.jsx(s,{item:!0,xs:12,sm:6,md:4,children:t.jsx(u,{fullWidth:!0,label:"Search Equipment",value:y,onChange:e=>Z(e.target.value),InputProps:{startAdornment:t.jsx(me,{position:"start",children:t.jsx(he,{})})}})}),t.jsx(s,{item:!0,xs:12,sm:6,md:4,children:t.jsxs(q,{fullWidth:!0,children:[t.jsx(C,{children:"Category Filter"}),t.jsxs(_,{value:D,label:"Category Filter",onChange:e=>ee(e.target.value),children:[t.jsx(h,{value:"",children:"All Categories"}),k.map(e=>t.jsx(h,{value:e,children:e},e))]})]})}),t.jsx(s,{item:!0,xs:12,sm:6,md:4,children:t.jsxs(q,{fullWidth:!0,children:[t.jsx(C,{children:"Status Filter"}),t.jsxs(_,{value:L,label:"Status Filter",onChange:e=>te(e.target.value),children:[t.jsx(h,{value:"",children:"All Status"}),t.jsx(h,{value:"operational",children:"Operational"}),t.jsx(h,{value:"maintenance",children:"Maintenance"}),t.jsx(h,{value:"out_of_order",children:"Out of Order"})]})]})})]}),t.jsx(s,{container:!0,spacing:3,children:de.map(e=>t.jsx(s,{item:!0,xs:12,sm:6,md:4,children:t.jsxs(xe,{children:[t.jsx(fe,{component:"img",height:"200",image:e.image_url||"https://picsum.photos/200/300",alt:e.name}),t.jsxs(ge,{children:[t.jsxs(b,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[t.jsx(p,{variant:"h6",children:e.name}),t.jsxs(b,{children:[t.jsx(G,{title:"Edit",children:t.jsx(H,{onClick:()=>Q(e),children:t.jsx(pe,{})})}),t.jsx(G,{title:"Delete",children:t.jsx(H,{color:"error",onClick:()=>{ce(e.id,e.name)},children:t.jsx(be,{})})})]})]}),t.jsx(J,{label:e.category,size:"small",sx:{mr:1,mb:1}}),t.jsx(J,{label:e.status,color:e.status==="operational"?"success":e.status==="maintenance"?"warning":"error",size:"small",sx:{mb:1}}),t.jsxs(p,{variant:"body2",color:"textSecondary",children:[e.manufacturer," ",e.model]}),t.jsx(p,{variant:"body2",children:e.description}),t.jsxs(p,{variant:"body2",color:"textSecondary",children:["Quantity: ",e.quantity]})]})]})},e.id))}),t.jsxs(je,{open:Y,onClose:()=>E(!1),maxWidth:"md",fullWidth:!0,children:[t.jsx(ve,{children:S?"Edit Equipment":"Add Equipment"}),t.jsx(ye,{children:t.jsx("form",{onSubmit:z,children:t.jsxs(s,{container:!0,spacing:2,sx:{mt:1},children:[t.jsx(s,{item:!0,xs:12,sm:6,children:t.jsx(u,{label:"Name",fullWidth:!0,required:!0,value:a.name,onChange:e=>c({...a,name:e.target.value})})}),t.jsx(s,{item:!0,xs:12,sm:6,children:t.jsxs(q,{fullWidth:!0,required:!0,children:[t.jsx(C,{children:"Category"}),t.jsx(_,{value:a.category,label:"Category",onChange:e=>c({...a,category:e.target.value}),children:k.map(e=>t.jsx(h,{value:e,children:e},e))})]})}),t.jsx(s,{item:!0,xs:12,children:t.jsxs(q,{fullWidth:!0,required:!0,children:[t.jsx(C,{children:"Lab"}),t.jsx(_,{value:a.lab_id,label:"Lab",onChange:e=>c({...a,lab_id:e.target.value}),children:ne.map(e=>t.jsx(h,{value:e.id,children:e.name},e.id))})]})}),t.jsx(s,{item:!0,xs:12,sm:6,children:t.jsx(u,{label:"Quantity",type:"number",fullWidth:!0,value:a.quantity,onChange:e=>c({...a,quantity:parseInt(e.target.value)})})}),t.jsx(s,{item:!0,xs:12,sm:6,children:t.jsx(u,{label:"Manufacturer",fullWidth:!0,value:a.manufacturer,onChange:e=>c({...a,manufacturer:e.target.value})})}),t.jsx(s,{item:!0,xs:12,sm:6,children:t.jsx(u,{label:"Model",fullWidth:!0,value:a.model,onChange:e=>c({...a,model:e.target.value})})}),t.jsx(s,{item:!0,xs:12,children:t.jsxs(b,{sx:{display:"flex",alignItems:"center",gap:2},children:[t.jsxs(W,{component:"label",variant:"outlined",startIcon:t.jsx(qe,{}),disabled:M,children:["Upload Image",t.jsx("input",{type:"file",hidden:!0,accept:"image/*",onChange:oe})]}),M&&t.jsx(R,{size:24}),a.image_url&&t.jsx(p,{variant:"body2",color:"textSecondary",children:"Image uploaded successfully"})]})}),t.jsx(s,{item:!0,xs:12,children:t.jsx(u,{label:"Description",fullWidth:!0,multiline:!0,rows:3,value:a.description,onChange:e=>c({...a,description:e.target.value})})}),t.jsxs(s,{item:!0,xs:12,children:[t.jsx(p,{variant:"h6",sx:{mb:2},children:"Specifications"}),t.jsxs(s,{container:!0,spacing:2,children:[t.jsx(s,{item:!0,xs:12,sm:6,children:t.jsx(u,{label:"Dimensions",fullWidth:!0,value:a.detailed_specs.dimensions,onChange:e=>v("dimensions",e.target.value)})}),t.jsx(s,{item:!0,xs:12,sm:6,children:t.jsx(u,{label:"Weight",fullWidth:!0,value:a.detailed_specs.weight,onChange:e=>v("weight",e.target.value)})}),t.jsx(s,{item:!0,xs:12,sm:6,children:t.jsx(u,{label:"Power Requirements",fullWidth:!0,value:a.detailed_specs.power_requirements,onChange:e=>v("power_requirements",e.target.value)})}),t.jsx(s,{item:!0,xs:12,sm:6,children:t.jsx(u,{label:"Calibration Interval",fullWidth:!0,value:a.detailed_specs.calibration_interval,onChange:e=>v("calibration_interval",e.target.value)})}),t.jsx(s,{item:!0,xs:12,sm:6,children:t.jsx(u,{label:"Safety Requirements",fullWidth:!0,value:a.detailed_specs.safety_requirements,onChange:e=>v("safety_requirements",e.target.value)})}),t.jsx(s,{item:!0,xs:12,sm:6,children:t.jsx(u,{label:"Operating Conditions",fullWidth:!0,value:a.detailed_specs.operating_conditions,onChange:e=>v("operating_conditions",e.target.value)})})]})]}),t.jsx(s,{item:!0,xs:12,children:t.jsxs(q,{fullWidth:!0,required:!0,children:[t.jsx(C,{children:"Status"}),t.jsxs(_,{value:a.status,label:"Status",onChange:e=>c({...a,status:e.target.value}),children:[t.jsx(h,{value:"operational",children:"Operational"}),t.jsx(h,{value:"maintenance",children:"Maintenance"}),t.jsx(h,{value:"out_of_order",children:"Out of Order"})]})]})})]})})}),t.jsxs(we,{children:[t.jsx(W,{onClick:()=>E(!1),children:"Cancel"}),t.jsx(W,{onClick:z,color:"primary",children:S?"Update":"Create"})]})]})]})}export{Ie as default};
//# sourceMappingURL=EquipmentManagement-OldqYNSn.js.map
