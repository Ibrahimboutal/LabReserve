import{r as s,u as _e,s as m,j as e,C as F,A as M,m as Le,B as j,T,a as o,b as Ie,P as Ne,c as De,d as Ee,e as ae,f as n,g as Pe,F as b,I as v,S as y,M as i,D as re,h as te,i as se,k as c,G as ne,l as ie}from"./index-z-43rxTh.js";import{d as le,v as qe}from"./CloudUpload-BGuNCpv-.js";function Me(){const[oe,ce]=s.useState([]),[de,ue]=s.useState(!0),[h,x]=s.useState(null),[me,C]=s.useState(!1),[w,he]=s.useState(null),[p,k]=s.useState(""),[S,O]=s.useState(""),[$,ge]=s.useState(""),[_,z]=s.useState(""),[L,B]=s.useState(""),[I,R]=s.useState(""),[N,G]=s.useState("available"),[D,H]=s.useState(null),[E,xe]=s.useState([]),{user:V}=_e(),[f,J]=s.useState(!1),[K,pe]=s.useState(""),[fe,P]=s.useState(!1),[r,d]=s.useState({name:"",location:"",manager_id:"",image_url:"",capacity:"",status:"",features:[],description:""}),[g,Q]=s.useState(1),[q,je]=s.useState(5);s.useEffect(()=>{A(),be()},[]);const A=async()=>{try{const{data:a,error:t}=await m.from("lab").select("*").order("created_at",{ascending:!1});if(t)throw t;ce(a||[])}catch(a){x(a.message)}finally{ue(!1)}},be=async()=>{try{const{data:a,error:t}=await m.from("users").select("id, email, role").order("created_at",{ascending:!1});if(t)throw t;xe(a||[])}catch(a){x(a.message)}},ve=a=>{pe(""),he(a),k(a.name),O(a.manager_id),ge(a.image_url),z(a.location),H(a.capacity),B(a.description),R(a.features),G(a.status),C(!0)},X=async(a,t,l,U)=>{try{const{error:u}=await m.from("notifications").insert(E.map(W=>({id:crypto.randomUUID(),user_id:W.id,created_by:a,title:t,message:l,type:U,read:!1,created_at:new Date().toISOString()})));if(u)throw u}catch(u){console.error("Error sending notifications:",u.message)}},Y=async a=>{try{const t=a.target.files?.[0];if(!t)return;J(!0);const l=t.name.split(".").pop(),u=`${`${qe()}.${l}`}`,{error:W}=await m.storage.from("lab-images").upload(u,t);if(W)throw W;const{data:{publicUrl:we}}=m.storage.from("lab-images").getPublicUrl(u);d(Se=>({...Se,image_url:we}))}catch(t){x("Error uploading image: "+t.message)}finally{J(!1)}},ye=async a=>{if(a.preventDefault(),!w||!p||!S||!$||!_||!D||!L||!I||!N){x("Please fill all fields"),console.error("Validation failed:",{selectedLab:w,newName:p,newManager:S,uploadingImage:f,newLocation:_,newCapacity:D,newDescription:L,newFeatures:I,newStatus:N});return}try{console.log("Updating lab with ID:",w.id);const{data:t,error:l}=await m.from("lab").update({name:p,manager_id:S,image_url:$,location:_,capacity:D,description:L,features:I,status:N}).eq("id",w.id);if(console.log("Update Response:",{data:t,error:l}),l)throw l;await X("system","Lab Updated",`Lab ${p} has been updated.`,"lab_update"),C(!1),A()}catch(t){console.error("Error updating lab:",t.message),x(t.message)}},Ce=async()=>{try{if(!V||V.role!=="admin")throw new Error("Admin privileges required");if(!r.name||!r.location||!r.manager_id||!r.image_url||!r.capacity||!r.description||!r.features||!r.status)throw new Error("Please fill all required fields");const a=Number(r.capacity);if(isNaN(a)||a<=0)throw new Error("Capacity must be a positive number");const{data:t,error:l}=await m.from("lab").insert([{name:r.name,location:r.location,manager_id:r.manager_id,image_url:r.image_url,capacity:a,description:r.description,features:r.features.map(U=>U.trim()),status:r.status}]).select();if(l)throw l;P(!1),d({name:"",location:"",manager_id:"",image_url:"",capacity:"",description:"",features:[],status:""}),A(),await X("system","New Lab Created",`Lab ${r.name} has been created.`,"lab_creation"),console.log("Lab created successfully:",t)}catch(a){a instanceof Error?(console.error("Error creating lab:",a.message),alert(`Error: ${a.message}`)):(console.error("Error creating lab:",a),alert("An unexpected error occurred."))}};if(de)return e.jsx(F,{});if(h)return e.jsx(M,{severity:"error",children:h});const Z=oe.slice((g-1)*q,g*q),ee=a=>{Q(a)};return h?e.jsx(Le,{sx:{display:"flex",justifyContent:"center",mt:4},children:e.jsx(M,{severity:"error",children:h})}):e.jsxs(j,{children:[h&&e.jsx(M,{severity:"error",children:h}),e.jsxs(j,{sx:{display:"flex",justifyContent:"space-between",mb:2},children:[e.jsx(T,{variant:"h6",children:"Lab Management"}),e.jsx(o,{variant:"contained",color:"primary",onClick:()=>P(!0),children:"Create Lab"})]}),e.jsx(Ie,{component:Ne,children:e.jsxs(De,{children:[e.jsx(Ee,{children:e.jsxs(ae,{children:[e.jsx(n,{children:"Name"}),e.jsx(n,{children:"Location"}),e.jsx(n,{children:"Manager"}),e.jsx(n,{children:"Capacity"}),e.jsx(n,{children:"Description"}),e.jsx(n,{children:"Features"}),e.jsx(n,{children:"Status"}),e.jsx(n,{children:"Actions"})]})}),e.jsx(Pe,{children:Z.map(a=>e.jsxs(ae,{children:[e.jsx(n,{children:a.name}),e.jsx(n,{children:a.location}),e.jsx(n,{children:E.find(t=>t.role==="lab_manager"&&t.id===a.manager_id)?.email||"Unassigned"}),e.jsx(n,{children:a.capacity}),e.jsx(n,{children:a.description}),e.jsx(n,{children:a.features}),e.jsx(n,{children:a.status}),e.jsx(n,{children:e.jsx(o,{variant:"contained",color:"primary",onClick:()=>ve(a),children:"Edit"})})]},a.id))})]})}),e.jsxs(j,{sx:{display:"flex",justifyContent:"space-between",mt:2},children:[e.jsxs(b,{size:"small",sx:{minWidth:120,mr:2},children:[e.jsx(v,{children:"Items Per Page"}),e.jsxs(y,{value:q,label:"Items Per Page",onChange:a=>{je(Number(a.target.value)),Q(1)},children:[e.jsx(i,{value:5,children:"5"}),e.jsx(i,{value:10,children:"10"}),e.jsx(i,{value:15,children:"15"})]})]}),e.jsx(o,{variant:"contained",color:"primary",onClick:()=>ee(g-1),disabled:g===1,children:"Previous"}),e.jsxs(T,{variant:"body1",children:["Page ",g]}),e.jsx(o,{variant:"contained",color:"primary",onClick:()=>ee(g+1),disabled:Z.length<q,children:"Next"})]}),e.jsxs(re,{open:me,onClose:()=>C(!1),children:[e.jsx(te,{children:"Edit Lab"}),e.jsxs(se,{children:[e.jsx(c,{label:"Name",value:p,onChange:a=>k(a.target.value),fullWidth:!0,required:!0,margin:"normal"}),e.jsxs(b,{fullWidth:!0,margin:"normal",required:!0,children:[e.jsx(v,{children:"Manager"}),e.jsx(y,{value:S,onChange:a=>O(a.target.value),label:"Manager",children:E.filter(a=>a.role==="lab_manager").map(a=>e.jsx(i,{value:a.id,children:a.email},a.id))})]}),e.jsx(ne,{item:!0,xs:12,children:e.jsxs(j,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsxs(o,{component:"label",variant:"outlined",startIcon:e.jsx(le,{}),disabled:f,children:["Upload Image",e.jsx("input",{type:"file",hidden:!0,accept:"image/*",onChange:Y})]}),f&&e.jsx(F,{size:24}),r.image_url&&e.jsx(T,{variant:"body2",color:"textSecondary",children:"Image uploaded successfully"})]})}),e.jsx(c,{label:"Location",value:_,onChange:a=>z(a.target.value),fullWidth:!0,required:!0,margin:"normal"}),e.jsx(c,{label:"Capacity",value:D,onChange:a=>H(Number(a.target.value)),fullWidth:!0,required:!0,margin:"normal"}),e.jsx(c,{label:"Description",value:L,onChange:a=>B(a.target.value),fullWidth:!0,required:!0,margin:"normal"}),e.jsx(c,{label:"Features",value:I,onChange:a=>R(a.target.value),fullWidth:!0,required:!0,margin:"normal"}),e.jsxs(b,{fullWidth:!0,margin:"normal",required:!0,children:[e.jsx(v,{children:"Status"}),e.jsxs(y,{value:N,onChange:a=>G(a.target.value),label:"Status",children:[e.jsx(i,{value:"available",children:"Available"}),e.jsx(i,{value:"occupied",children:"Occupied"}),e.jsx(i,{value:"maintenance",children:"Maintenance"})]})]})]}),e.jsxs(ie,{children:[e.jsx(o,{onClick:()=>C(!1),children:"Cancel"}),e.jsx(o,{onClick:ye,color:"primary",children:"Save"})]})]}),e.jsxs(re,{open:fe,onClose:()=>P(!1),children:[e.jsx(te,{children:"Create Lab"}),e.jsxs(se,{children:[K&&e.jsx(M,{severity:"error",children:K}),e.jsx(c,{margin:"dense",label:"Name",fullWidth:!0,required:!0,value:r.name,onChange:a=>d({...r,name:a.target.value})}),e.jsx(c,{margin:"dense",label:"Location",fullWidth:!0,required:!0,value:r.location,onChange:a=>d({...r,location:a.target.value})}),e.jsxs(b,{fullWidth:!0,margin:"dense",required:!0,children:[e.jsx(v,{children:"Manager ID"}),e.jsx(y,{label:"Manager ID",value:r.manager_id,onChange:a=>d({...r,manager_id:a.target.value}),children:E.filter(a=>a.role==="lab_manager").map(a=>e.jsx(i,{value:a.id,children:a.email},a.id))})]}),e.jsx(ne,{item:!0,xs:12,children:e.jsxs(j,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsxs(o,{component:"label",variant:"outlined",startIcon:e.jsx(le,{}),disabled:f,children:["Upload Image",e.jsx("input",{type:"file",hidden:!0,accept:"image/*",onChange:Y})]}),f&&e.jsx(F,{size:24}),r.image_url&&e.jsx(T,{variant:"body2",color:"textSecondary",children:"Image uploaded successfully"})]})}),e.jsx(c,{margin:"dense",label:"Capacity",type:"number",fullWidth:!0,required:!0,value:r.capacity,onChange:a=>d({...r,capacity:a.target.value}),InputProps:{inputProps:{min:1}}}),e.jsx(c,{label:"Description",value:r.description,onChange:a=>d({...r,description:a.target.value}),fullWidth:!0,required:!0,margin:"normal"}),e.jsx(c,{label:"Features",value:r.features,onChange:a=>d({...r,features:a.target.value.split(",")}),fullWidth:!0,required:!0,margin:"normal"}),e.jsxs(b,{fullWidth:!0,margin:"normal",required:!0,children:[e.jsx(v,{children:"Status"}),e.jsxs(y,{value:r.status,onChange:a=>d({...r,status:a.target.value}),label:"Status",children:[e.jsx(i,{value:"available",children:"Available"}),e.jsx(i,{value:"occupied",children:"Occupied"}),e.jsx(i,{value:"maintenance",children:"Maintenance"})]})]})]}),e.jsxs(ie,{children:[e.jsx(o,{onClick:()=>P(!1),children:"Cancel"}),e.jsx(o,{onClick:Ce,color:"primary",children:"Create Lab"})]})]})]})}export{Me as default};
//# sourceMappingURL=LabManagement-CAHf8qSH.js.map
