import{r as n,s as d,j as t,C as J,A as fe,B as v,T as h,a as y,G as s,k as c,n as pe,o as je,F as b,I as w,S as C,M as l,p as ve,q as ye,t as be,v as K,w as V,x as we,y as X,D as Ce,h as _e,i as qe,l as Se}from"./index-z-43rxTh.js";import{d as Ee}from"./Delete-CbxsixXQ.js";import{d as We,v as Ie}from"./CloudUpload-BGuNCpv-.js";const P={dimensions:"",weight:"",power_requirements:"",calibration_interval:"",safety_requirements:"",operating_conditions:""};function Le(){const[Y,Z]=n.useState([]),[ee,f]=n.useState(!0),[M,p]=n.useState(null),[te,S]=n.useState(!1),[E,T]=n.useState(null),[_,re]=n.useState(""),[D,ae]=n.useState(""),[A,se]=n.useState(""),[U,ne]=n.useState([]),[$,O]=n.useState(!1),[ie,le]=n.useState([]),[a,o]=n.useState({name:"",category:"",description:"",manufacturer:"",model:"",quantity:1,image_url:"",detailed_specs:P,status:"operational",lab_id:""}),[x,k]=n.useState(1),[q,oe]=n.useState(5),[de,ce]=n.useState([]);n.useEffect(()=>{ue(),me()},[]);const ue=async()=>{try{const{data:e,error:r}=await d.from("lab").select("id, name, location").order("name");if(r)throw r;ce(e)}catch(e){p(e.message)}finally{f(!1)}};n.useEffect(()=>{F(),N().then(e=>ne(e||[])),N()},[]);const F=async()=>{try{const{data:e,error:r}=await d.from("equipment").select("*").order("name");if(r)throw r;Z(e)}catch(e){p(e.message)}finally{f(!1)}},N=async()=>{try{f(!0);const{data:e,error:r}=await d.from("equipment_categories").select("*").order("name");if(r)throw r;return e?e.map(u=>u.name):[]}catch(e){p(e.message)}finally{f(!1)}},me=async()=>{try{const{data:e,error:r}=await d.from("users").select("id, email, role").order("created_at",{ascending:!1});if(r)throw r;le(e||[])}catch(e){p(e.message)}},z=async(e,r,u,m)=>{try{const{error:i}=await d.from("notifications").insert(ie.map(g=>({id:crypto.randomUUID(),user_id:g.id,created_by:e,title:r,message:u,type:m,read:!1,created_at:new Date().toISOString()})));if(i)throw i}catch(i){console.error("Error sending notifications:",i.message)}},he=async e=>{try{const r=e.target.files?.[0];if(!r)return;O(!0);const u=r.name.split(".").pop(),i=`${`${Ie()}.${u}`}`,{error:g}=await d.storage.from("equipment-images").upload(i,r);if(g)throw g;const{data:{publicUrl:W}}=d.storage.from("equipment-images").getPublicUrl(i);o(I=>({...I,image_url:W}))}catch(r){p("Error uploading image: "+r.message)}finally{O(!1)}},B=e=>{e?(o({name:e.name,category:e.category,description:e.description||"",manufacturer:e.manufacturer||"",model:e.model||"",quantity:1,image_url:e.image_url||"",detailed_specs:e.detailed_specs||P,status:e.status,lab_id:e.lab_id}),T(e)):(o({name:"",category:"",description:"",manufacturer:"",model:"",quantity:1,image_url:"",detailed_specs:P,status:"operational",lab_id:""}),T(null)),S(!0)},Q=async e=>{e.preventDefault(),f(!0);try{if(E){const{error:r}=await d.from("equipment").update(a).eq("id",E.id);if(r)throw r}else{const{error:r}=await d.from("equipment").insert([a]);if(r)throw r;await z("System","New Equipment Added",`New equipment "${a.name}" has been added.`,"Equipment created")}S(!1),F()}catch(r){p(r.message)}finally{f(!1)}},j=(e,r)=>{o(u=>({...u,detailed_specs:{...u.detailed_specs,[e]:r}}))},L=Y.filter(e=>{const r=e.name.toLowerCase().includes(_.toLowerCase())||e.description?.toLowerCase().includes(_.toLowerCase())||e.manufacturer?.toLowerCase().includes(_.toLowerCase())||e.model?.toLowerCase().includes(_.toLowerCase()),u=!D||e.category===D,m=!A||e.status===A;return r&&u&&m});if(ee)return t.jsx(J,{});if(M)return t.jsx(fe,{severity:"error",children:M});const xe=L.slice((x-1)*q,x*q),R=e=>{k(e)};async function ge(e,r){if(window.confirm("Are you sure you want to delete this equipment?"))try{const{data:m,error:i}=await d.from("equipment").select("status").eq("id",e).single();if(i)throw new Error(`Failed to fetch equipment details: ${i.message}`);if(!m)throw new Error("Equipment not found");const g={reserved:"This equipment is currently reserved and cannot be deleted.",maintenance:"This equipment is currently under maintenance and cannot be deleted.",out_of_order:"This equipment is out of order and cannot be deleted until resolved."},W=m.status;if(g[W])throw new Error(g[W]);const{data:I,error:G}=await d.from("reservations").select("*").eq("equipment_id",e).in("status",["pending","approved"]);if(G)throw new Error(`Failed to check reservations: ${G.message}`);if(I&&I.length>0)throw new Error("This equipment has active reservations and cannot be deleted.");const{error:H}=await d.from("equipment").delete().eq("id",e);if(H)throw new Error(`Failed to delete equipment: ${H.message}`);await z("System","Equipment Deleted",`Equipment: "${r}" has been deleted.`,"Equipment deleted"),F()}catch(m){let i=m.message||"An unexpected error occurred while deleting the equipment.";i.includes("active reservations")&&(i="This equipment has active reservations and cannot be deleted."),window.alert(i),console.error("Error:",m)}}return t.jsxs(v,{children:[t.jsxs(v,{sx:{display:"flex",justifyContent:"space-between",mb:2},children:[t.jsx(h,{variant:"h6",children:"Equipment Management"}),t.jsx(y,{variant:"contained",color:"primary",onClick:()=>B(),children:"Add Equipment"})]}),t.jsxs(s,{container:!0,spacing:2,sx:{mb:3},children:[t.jsx(s,{item:!0,xs:12,sm:6,md:4,children:t.jsx(c,{fullWidth:!0,label:"Search Equipment",value:_,onChange:e=>re(e.target.value),InputProps:{startAdornment:t.jsx(pe,{position:"start",children:t.jsx(je,{})})}})}),t.jsx(s,{item:!0,xs:12,sm:6,md:4,children:t.jsxs(b,{fullWidth:!0,children:[t.jsx(w,{children:"Category Filter"}),t.jsxs(C,{value:D,label:"Category Filter",onChange:e=>ae(e.target.value),children:[t.jsx(l,{value:"",children:"All Categories"}),U.map(e=>t.jsx(l,{value:e,children:e},e))]})]})}),t.jsx(s,{item:!0,xs:12,sm:6,md:4,children:t.jsxs(b,{fullWidth:!0,children:[t.jsx(w,{children:"Status Filter"}),t.jsxs(C,{value:A,label:"Status Filter",onChange:e=>se(e.target.value),children:[t.jsx(l,{value:"",children:"All Status"}),t.jsx(l,{value:"operational",children:"Operational"}),t.jsx(l,{value:"maintenance",children:"Maintenance"}),t.jsx(l,{value:"out_of_order",children:"Out of Order"})]})]})})]}),t.jsx(s,{container:!0,spacing:3,children:xe.map(e=>t.jsx(s,{item:!0,xs:12,sm:6,md:4,children:t.jsxs(ve,{children:[t.jsx(ye,{component:"img",height:"200",image:e.image_url||"https://picsum.photos/200/300",alt:e.name}),t.jsxs(be,{children:[t.jsxs(v,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[t.jsx(h,{variant:"h6",children:e.name}),t.jsxs(v,{children:[t.jsx(K,{title:"Edit",children:t.jsx(V,{onClick:()=>B(e),children:t.jsx(we,{})})}),t.jsx(K,{title:"Delete",children:t.jsx(V,{color:"error",onClick:()=>{ge(e.id,e.name)},children:t.jsx(Ee,{})})})]})]}),t.jsx(X,{label:e.category,size:"small",sx:{mr:1,mb:1}}),t.jsx(X,{label:e.status,color:e.status==="operational"?"success":e.status==="maintenance"?"warning":"error",size:"small",sx:{mb:1}}),t.jsxs(h,{variant:"body2",color:"textSecondary",children:[e.manufacturer," ",e.model]}),t.jsx(h,{variant:"body2",children:e.description}),t.jsxs(h,{variant:"body2",color:"textSecondary",children:["Quantity: ",e.quantity]})]})]})},e.id))}),t.jsxs(v,{sx:{display:"flex",justifyContent:"center",mt:4},children:[t.jsxs(b,{size:"small",sx:{minWidth:120,mr:2},children:[t.jsx(w,{children:"Items Per Page"}),t.jsxs(C,{value:q,label:"Items Per Page",onChange:e=>{oe(Number(e.target.value)),k(1)},children:[t.jsx(l,{value:5,children:"5"}),t.jsx(l,{value:10,children:"10"}),t.jsx(l,{value:15,children:"15"})]})]}),t.jsx(y,{variant:"outlined",disabled:x===1,onClick:()=>R(x-1),sx:{mr:1},children:"Previous"}),t.jsxs(h,{variant:"body1",sx:{alignSelf:"center"},children:["Page ",x," of ",Math.ceil(L.length/q)]}),t.jsx(y,{variant:"outlined",disabled:x>=Math.ceil(L.length/q),onClick:()=>R(x+1),sx:{ml:1},children:"Next"})]}),t.jsxs(Ce,{open:te,onClose:()=>S(!1),maxWidth:"md",fullWidth:!0,children:[t.jsx(_e,{children:E?"Edit Equipment":"Add Equipment"}),t.jsx(qe,{children:t.jsx("form",{onSubmit:Q,children:t.jsxs(s,{container:!0,spacing:2,sx:{mt:1},children:[t.jsx(s,{item:!0,xs:12,sm:6,children:t.jsx(c,{label:"Name",fullWidth:!0,required:!0,value:a.name,onChange:e=>o({...a,name:e.target.value})})}),t.jsx(s,{item:!0,xs:12,sm:6,children:t.jsxs(b,{fullWidth:!0,required:!0,children:[t.jsx(w,{children:"Category"}),t.jsx(C,{value:a.category,label:"Category",onChange:e=>o({...a,category:e.target.value}),children:U.map(e=>t.jsx(l,{value:e,children:e},e))})]})}),t.jsx(s,{item:!0,xs:12,children:t.jsxs(b,{fullWidth:!0,required:!0,children:[t.jsx(w,{children:"Lab"}),t.jsx(C,{value:a.lab_id,label:"Lab",onChange:e=>o({...a,lab_id:e.target.value}),children:de.map(e=>t.jsx(l,{value:e.id,children:e.name},e.id))})]})}),t.jsx(s,{item:!0,xs:12,sm:6,children:t.jsx(c,{label:"Quantity",type:"number",fullWidth:!0,value:a.quantity,onChange:e=>o({...a,quantity:parseInt(e.target.value)})})}),t.jsx(s,{item:!0,xs:12,sm:6,children:t.jsx(c,{label:"Manufacturer",fullWidth:!0,value:a.manufacturer,onChange:e=>o({...a,manufacturer:e.target.value})})}),t.jsx(s,{item:!0,xs:12,sm:6,children:t.jsx(c,{label:"Model",fullWidth:!0,value:a.model,onChange:e=>o({...a,model:e.target.value})})}),t.jsx(s,{item:!0,xs:12,children:t.jsxs(v,{sx:{display:"flex",alignItems:"center",gap:2},children:[t.jsxs(y,{component:"label",variant:"outlined",startIcon:t.jsx(We,{}),disabled:$,children:["Upload Image",t.jsx("input",{type:"file",hidden:!0,accept:"image/*",onChange:he})]}),$&&t.jsx(J,{size:24}),a.image_url&&t.jsx(h,{variant:"body2",color:"textSecondary",children:"Image uploaded successfully"})]})}),t.jsx(s,{item:!0,xs:12,children:t.jsx(c,{label:"Description",fullWidth:!0,multiline:!0,rows:3,value:a.description,onChange:e=>o({...a,description:e.target.value})})}),t.jsxs(s,{item:!0,xs:12,children:[t.jsx(h,{variant:"h6",sx:{mb:2},children:"Specifications"}),t.jsxs(s,{container:!0,spacing:2,children:[t.jsx(s,{item:!0,xs:12,sm:6,children:t.jsx(c,{label:"Dimensions",fullWidth:!0,value:a.detailed_specs.dimensions,onChange:e=>j("dimensions",e.target.value)})}),t.jsx(s,{item:!0,xs:12,sm:6,children:t.jsx(c,{label:"Weight",fullWidth:!0,value:a.detailed_specs.weight,onChange:e=>j("weight",e.target.value)})}),t.jsx(s,{item:!0,xs:12,sm:6,children:t.jsx(c,{label:"Power Requirements",fullWidth:!0,value:a.detailed_specs.power_requirements,onChange:e=>j("power_requirements",e.target.value)})}),t.jsx(s,{item:!0,xs:12,sm:6,children:t.jsx(c,{label:"Calibration Interval",fullWidth:!0,value:a.detailed_specs.calibration_interval,onChange:e=>j("calibration_interval",e.target.value)})}),t.jsx(s,{item:!0,xs:12,sm:6,children:t.jsx(c,{label:"Safety Requirements",fullWidth:!0,value:a.detailed_specs.safety_requirements,onChange:e=>j("safety_requirements",e.target.value)})}),t.jsx(s,{item:!0,xs:12,sm:6,children:t.jsx(c,{label:"Operating Conditions",fullWidth:!0,value:a.detailed_specs.operating_conditions,onChange:e=>j("operating_conditions",e.target.value)})})]})]}),t.jsx(s,{item:!0,xs:12,children:t.jsxs(b,{fullWidth:!0,required:!0,children:[t.jsx(w,{children:"Status"}),t.jsxs(C,{value:a.status,label:"Status",onChange:e=>o({...a,status:e.target.value}),children:[t.jsx(l,{value:"operational",children:"Operational"}),t.jsx(l,{value:"maintenance",children:"Maintenance"}),t.jsx(l,{value:"out_of_order",children:"Out of Order"})]})]})})]})})}),t.jsxs(Se,{children:[t.jsx(y,{onClick:()=>S(!1),children:"Cancel"}),t.jsx(y,{onClick:Q,color:"primary",children:E?"Update":"Create"})]})]})]})}export{Le as default};
//# sourceMappingURL=EquipmentManagement-KDSVB9se.js.map
