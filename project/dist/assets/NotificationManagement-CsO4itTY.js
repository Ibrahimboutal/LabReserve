import{r as i,u as Ie,a2 as ke,s as g,j as e,B as p,T as W,a as j,G as N,k as E,F as B,I as M,S as I,M as x,A as Pe,D as te,h as se,i as re,l as ae,Z as Re,C as Ue,b as Oe,P as Ae,c as Le,d as We,e as F,f as o,g as Be,w as ie,x as Me,z as Fe}from"./index-z-43rxTh.js";import{d as ze}from"./Delete-CbxsixXQ.js";import{u as He,d as $e}from"./useConfirmDialog-E9TJW4YP.js";import{T as qe}from"./TablePagination-DEp9dKUa.js";import"./DialogContentText-DCVk7Q-l.js";import"./LastPage-9l3JZRRp.js";function Ve(){const[l,f]=i.useState(null),[z,m]=i.useState([]),{user:w}=Ie(),[ne,H]=i.useState(!1),[$,k]=i.useState(null),{showNotification:q,NotificationComponent:oe}=ke(),{confirm:le,ConfirmDialogComponent:ce}=He(),[C,S]=i.useState(!1),[de,P]=i.useState(!1),[ue,R]=i.useState(""),[he,T]=i.useState(!1),[me,y]=i.useState(!1),[Y,G]=i.useState(null),[U,X]=i.useState(0),[v,xe]=i.useState(5),[_,fe]=i.useState(""),[O,ge]=i.useState(""),[A,pe]=i.useState(""),[u,Z]=i.useState("created_at"),[b,J]=i.useState("desc"),[D,je]=i.useState("all"),[ye,be]=i.useState([]),we=24;i.useEffect(()=>{Q(),Ce(),K()},[]);const K=async()=>{try{const{data:t,error:s}=await g.from("users").select("id, email, role");if(s)throw s;return be(t||[]),t.map(r=>r.id)}catch(t){return console.error("Error fetching users:",t.message),[]}},Q=async()=>{try{H(!0);const{data:t,error:s}=await g.from("notifications").select(`
          *,
          users: user_id(email, role)
        `).order("created_at",{ascending:!1});if(s)throw s;m(t||[])}catch(t){k(t.message),q(t.message,"Error")}finally{H(!1)}},Ce=()=>{const t=g.channel("notifications").on("postgres_changes",{event:"*",schema:"public",table:"notifications"},async s=>{if(console.log("Notification change detected:",s),!s.new||!s.new.id){console.warn("Invalid payload received:",s);return}if(s.eventType==="INSERT"){const r=s.new;m(a=>{if(a.some(n=>n.id===r.id))return console.warn("Duplicate notification skipped:",r.id),a;const c=a.find(n=>n.id===r.id)?.users;return c?[{...r,users:c},...a]:(g.from("users").select("email, role").eq("id",r.user_id).single().then(({data:n,error:d})=>{if(d)throw d;m(L=>L.some(Ee=>Ee.id===r.id)?L:[{...r,users:{email:n?.email||"",role:n?.role||""}},...L])}).then(()=>Promise.resolve()).then(void 0,n=>{console.error("Error fetching user data:",n.message)}),[{...r,users:{email:"",role:""}},...a])})}else s.eventType==="UPDATE"?m(r=>r.map(a=>a.id===s.new.id?{...s.new,users:a.users}:a)):s.eventType==="DELETE"&&m(r=>r.filter(a=>a.id!==s.old.id))}).subscribe();return()=>{t.unsubscribe()}},Se=async()=>{if(!l||!w)return;const{isOptimistic:t,id:s,...r}=l,a=`temp-${Date.now()}`;try{let h;D==="all"?h=(await K()).map(d=>({...r,user_id:d,read:!1,created_at:new Date().toISOString(),created_by:l.created_by||"System"})):h=[{...r,user_id:D,read:!1,created_at:new Date().toISOString(),created_by:l.created_by||"System"}],m(n=>[{...l,id:a,isOptimistic:!0,created_at:new Date().toISOString(),created_by:l.created_by||"System",users:{email:w?.email||"System",role:w?.role||"System"}},...n]);let c;if(C&&l.id){if(c=await g.from("notifications").update({...r,created_by:l.created_by}).eq("id",l.id),c.error)throw c.error;R("Notification updated successfully!"),m(n=>n.map(d=>d.id===l.id?{...d,isOptimistic:!1}:d))}else{if(c=await g.from("notifications").insert(h).select(),c.error)throw c.error;R(D==="all"?"Notification sent to all users successfully!":"Notification sent to the selected user successfully!"),m(n=>n.map(d=>d.id===a&&c?.data?.[0]?{...d,...c.data[0],isOptimistic:!1}:d))}S(!1),f(null),P(!0),y(!1)}catch(h){k(h.message),q(h.message,"Error"),m(c=>c.filter(n=>n.id!==a))}},Te=t=>{f(t),S(!0),y(!0)},ve=async()=>{if(Y)try{if(!await le({title:"Delete Notification",message:"Are you sure you want to delete this notification?",confirmText:"Delete",severity:"error"}))return;const{error:s}=await g.from("notifications").delete().eq("id",Y);if(s)throw s;R("Notification deleted successfully!"),P(!0),Q()}catch(t){k(t.message)}finally{T(!1),G(null)}},_e=z.filter(t=>{const s=_?t.title.toLowerCase().includes(_.toLowerCase())||t.message.toLowerCase().includes(_.toLowerCase()):!0,r=O?t.type===O:!0,a=A?t.created_by===A:!0,h=new Date(t.created_at),c=new Date(Date.now()-we*60*60*1e3),n=h<c;return s&&r&&a&&!n}).sort((t,s)=>u==="created_at"?b==="asc"?new Date(t.created_at).getTime()-new Date(s.created_at).getTime():new Date(s.created_at).getTime()-new Date(t.created_at).getTime():b==="asc"?t.type.localeCompare(s.type):s.type.localeCompare(t.type)),V=["Info","Warning","Error","Success","System"],De=["admin","lab_manager"],ee=_e.slice(U*v,U*v+v);function Ne(t){if(t.length<=20)return t;const[r,a]=t.split("@");return`${r.slice(0,20-a.length-3)}...@${a}`}return e.jsxs(p,{sx:{p:3},children:[e.jsxs(p,{sx:{p:3},children:[e.jsx(W,{variant:"h4",gutterBottom:!0,children:"Notification Management"}),e.jsx(j,{variant:"contained",color:"primary",onClick:()=>{const t=w?.role||"System";f({title:"",message:"",type:"",created_by:t}),S(!1),y(!0)},children:"Create Notification"})]}),e.jsx(p,{sx:{mb:3},children:e.jsxs(N,{container:!0,spacing:2,alignItems:"center",children:[e.jsx(N,{item:!0,xs:12,sm:6,md:4,children:e.jsx(E,{fullWidth:!0,label:"Search by Title or Message",variant:"outlined",size:"small",value:_,onChange:t=>fe(t.target.value),InputProps:{sx:{borderRadius:2}}})}),e.jsx(N,{item:!0,xs:12,sm:6,md:4,children:e.jsxs(B,{fullWidth:!0,size:"small",children:[e.jsx(M,{children:"Type"}),e.jsxs(I,{value:O,onChange:t=>ge(t.target.value),label:"Type",sx:{borderRadius:2},children:[e.jsx(x,{value:"",children:"All Types"}),V.map(t=>e.jsx(x,{value:t,children:t},t))]})]})}),e.jsx(N,{item:!0,xs:12,sm:6,md:4,children:e.jsxs(B,{fullWidth:!0,size:"small",children:[e.jsx(M,{children:"The Creator Role"}),e.jsxs(I,{value:A,onChange:t=>pe(t.target.value),label:"The Creator Role",sx:{borderRadius:2},children:[e.jsx(x,{value:"",children:"All Creators"}),De.map(t=>e.jsx(x,{value:t,children:t},t))]})]})})]})}),e.jsx(p,{sx:{mb:3},children:e.jsxs(p,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsxs(W,{variant:"caption",color:"text.secondary",children:["Sorted by: ",u==="created_at"?"Date":"Type"," (",b.toUpperCase(),")"]}),e.jsxs(p,{children:[e.jsxs(j,{variant:u==="created_at"?"contained":"outlined",color:u==="created_at"?"primary":"inherit",size:"small",onClick:()=>{Z("created_at"),J(t=>t==="asc"?"desc":"asc")},sx:{mr:1,fontWeight:u==="created_at"?"bold":"normal"},children:["Created At ",u==="created_at"&&(b==="asc"?"↑":"↓")]}),e.jsxs(j,{variant:u==="type"?"contained":"outlined",color:u==="type"?"primary":"inherit",size:"small",onClick:()=>{Z("type"),J(t=>t==="asc"?"desc":"asc")},sx:{ml:1,fontWeight:u==="type"?"bold":"normal"},children:["Type ",u==="type"&&(b==="asc"?"↑":"↓")]})]})]})}),$&&e.jsx(Pe,{severity:"error",sx:{mb:2},children:$}),e.jsxs(te,{open:me,onClose:()=>{y(!1),f(null),S(!1)},maxWidth:"sm",fullWidth:!0,sx:{"& .MuiDialog-paper":{maxHeight:"80vh",overflowY:"auto",borderRadius:2,boxShadow:"0 4px 20px rgba(0, 0, 0, 0.2)"}},children:[e.jsx(se,{children:C?"Edit Notification":"Create Notification"}),e.jsxs(re,{sx:{p:1,overflow:"auto",maxHeight:"60vh",mt:2,mb:2,borderRadius:2},children:[e.jsxs(B,{fullWidth:!0,sx:{mb:2,mt:2},children:[e.jsx(M,{id:"send-to-label",sx:{mb:2},children:"Send To"}),e.jsxs(I,{labelId:"send-to-label",value:D,onChange:t=>je(t.target.value),label:"Send To",MenuProps:{PaperProps:{style:{maxHeight:200,overflowY:"auto"}}},children:[e.jsx(x,{value:"all",children:"All Users"}),ye.map(t=>e.jsx(x,{value:t.id,children:Ne(t.email)},t.id))]})]}),e.jsx(E,{label:"Created By",value:l?.created_by||"Unknown",disabled:!0,fullWidth:!0,sx:{mb:2}}),e.jsx(E,{label:"Title",value:l?.title||"",onChange:t=>f({...l,title:t.target.value}),fullWidth:!0,sx:{mb:2}}),e.jsx(E,{label:"Message",value:l?.message||"",onChange:t=>f({...l,message:t.target.value}),fullWidth:!0,multiline:!0,rows:4,sx:{mb:2}}),e.jsxs(I,{value:l?.type||"",onChange:t=>f({...l,type:t.target.value}),fullWidth:!0,displayEmpty:!0,sx:{mb:2},children:[e.jsx(x,{value:"",disabled:!0,children:"Select Notification Type"}),V.map(t=>e.jsx(x,{value:t,children:t},t))]})]}),e.jsxs(ae,{children:[e.jsx(j,{onClick:()=>y(!1),color:"primary",children:"Cancel"}),e.jsx(j,{onClick:Se,color:"primary",startIcon:C?e.jsx(Re,{}):void 0,autoFocus:!0,children:C?"Update Notification":"Create Notification"})]})]}),ne?e.jsx(Ue,{}):e.jsxs(Oe,{component:Ae,children:[e.jsxs(Le,{children:[e.jsx(We,{children:e.jsxs(F,{children:[e.jsx(o,{children:"Created By"}),e.jsx(o,{children:"Title"}),e.jsx(o,{children:"Message"}),e.jsx(o,{children:"Type"}),e.jsx(o,{children:"Created At"}),e.jsx(o,{children:"Users"}),e.jsx(o,{children:"Role"}),e.jsx(o,{children:"Read"}),e.jsx(o,{align:"right",children:"Actions"})]})}),e.jsx(Be,{children:ee.length===0?e.jsx(F,{children:e.jsx(o,{colSpan:7,align:"center",children:"No notifications available."})}):ee.map(t=>e.jsxs(F,{children:[e.jsx(o,{children:t.created_by||"Unknown"}),e.jsx(o,{children:t.title}),e.jsx(o,{children:t.message}),e.jsx(o,{children:t.type}),e.jsx(o,{children:new Date(t.created_at).toLocaleString()}),e.jsx(o,{children:t.users.email||"Unknown"}),e.jsx(o,{children:t.users.role||"Unknown"}),e.jsx(o,{children:t.read?"Yes":"No"}),e.jsxs(o,{align:"right",children:[e.jsx(ie,{color:"primary",onClick:()=>Te(t),children:e.jsx(Me,{})}),e.jsx(ie,{color:"error",onClick:()=>{G(t.id),T(!0)},children:e.jsx(ze,{})})]})]},t.id))})]}),e.jsx(qe,{component:"div",count:z.length,page:U,onPageChange:(t,s)=>X(s),rowsPerPage:v,onRowsPerPageChange:t=>{xe(parseInt(t.target.value,10)),X(0)}})]}),e.jsx(Fe,{open:de,autoHideDuration:3e3,onClose:()=>P(!1),message:ue}),e.jsxs(te,{open:he,onClose:()=>T(!1),children:[e.jsx(se,{children:"Delete Notification"}),e.jsx(re,{children:e.jsxs(p,{sx:{display:"flex",alignItems:"center"},children:[e.jsx($e,{color:"warning",sx:{mr:2}}),e.jsx(W,{children:"Are you sure you want to delete this notification?"})]})}),e.jsxs(ae,{children:[e.jsx(j,{onClick:()=>T(!1),color:"primary",children:"Cancel"}),e.jsx(j,{onClick:ve,color:"error",autoFocus:!0,children:"Delete"})]})]}),e.jsx(oe,{}),e.jsx(ce,{})]})}export{Ve as default};
//# sourceMappingURL=NotificationManagement-CsO4itTY.js.map
