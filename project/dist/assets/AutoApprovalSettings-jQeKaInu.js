import{a3 as De,a4 as Le,r as b,a5 as Te,a6 as Ue,a7 as ke,a8 as Re,a9 as G,T as L,j as e,aa as fe,ab as _e,ac as Be,ad as ye,ae as Ie,u as Ne,s as f,B as V,C as $e,A as Fe,P as ee,af as te,b as ge,c as se,d as re,e as E,f as l,g as ne,y as ae,Q as oe,a as be,D as Oe,h as Me,i as ze,l as We,z as He}from"./index-z-43rxTh.js";import{T as he,d as Qe}from"./History-C3UuzGCI.js";import{T as xe}from"./TablePagination-DEp9dKUa.js";import"./LastPage-9l3JZRRp.js";function Ve(u){return Le("MuiFormControlLabel",u)}const O=De("MuiFormControlLabel",["root","labelPlacementStart","labelPlacementTop","labelPlacementBottom","disabled","label","error","required","asterisk"]),Ge=["checked","className","componentsProps","control","disabled","disableTypography","inputRef","label","labelPlacement","name","onChange","required","slotProps","value"],Je=u=>{const{classes:h,disabled:_,labelPlacement:T,error:S,required:y}=u,U={root:["root",_&&"disabled",`labelPlacement${ye(T)}`,S&&"error",y&&"required"],label:["label",_&&"disabled"],asterisk:["asterisk",S&&"error"]};return Ie(U,Ve,h)},Ke=_e("label",{name:"MuiFormControlLabel",slot:"Root",overridesResolver:(u,h)=>{const{ownerState:_}=u;return[{[`& .${O.label}`]:h.label},h.root,h[`labelPlacement${ye(_.labelPlacement)}`]]}})(({theme:u,ownerState:h})=>G({display:"inline-flex",alignItems:"center",cursor:"pointer",verticalAlign:"middle",WebkitTapHighlightColor:"transparent",marginLeft:-11,marginRight:16,[`&.${O.disabled}`]:{cursor:"default"}},h.labelPlacement==="start"&&{flexDirection:"row-reverse",marginLeft:16,marginRight:-11},h.labelPlacement==="top"&&{flexDirection:"column-reverse",marginLeft:16},h.labelPlacement==="bottom"&&{flexDirection:"column",marginLeft:16},{[`& .${O.label}`]:{[`&.${O.disabled}`]:{color:(u.vars||u).palette.text.disabled}}})),Xe=_e("span",{name:"MuiFormControlLabel",slot:"Asterisk",overridesResolver:(u,h)=>h.asterisk})(({theme:u})=>({[`&.${O.error}`]:{color:(u.vars||u).palette.error.main}})),Ye=b.forwardRef(function(h,_){var T,S;const y=Te({props:h,name:"MuiFormControlLabel"}),{className:U,componentsProps:M={},control:q,disabled:z,disableTypography:W,label:J,labelPlacement:K="end",required:H,slotProps:N={}}=y,k=Ue(y,Ge),A=ke(),v=(T=z??q.props.disabled)!=null?T:A?.disabled,C=H??q.props.required,$={disabled:v,required:C};["checked","name","onChange","value","inputRef"].forEach(D=>{typeof q.props[D]>"u"&&typeof y[D]<"u"&&($[D]=y[D])});const F=Re({props:y,muiFormControl:A,states:["error"]}),R=G({},y,{disabled:v,labelPlacement:K,required:C,error:F.error}),P=Je(R),B=(S=N.typography)!=null?S:M.typography;let j=J;return j!=null&&j.type!==L&&!W&&(j=e.jsx(L,G({component:"span"},B,{className:fe(P.label,B?.className),children:j}))),e.jsxs(Ke,G({className:fe(P.root,U),ownerState:R,ref:_},k,{children:[b.cloneElement(q,$),C?e.jsxs(Be,{display:"block",children:[j,e.jsxs(Xe,{ownerState:R,"aria-hidden":!0,className:P.asterisk,children:["â€‰","*"]})]}):j]}))});function rt(){const{user:u}=Ne(),[h,_]=b.useState([]),[T,S]=b.useState([]),[y,U]=b.useState(!0),[M,q]=b.useState(null),[z,W]=b.useState(!1),[J,K]=b.useState(""),[H,N]=b.useState(!1),[k,A]=b.useState([]),[v,C]=b.useState([]),[$,F]=b.useState([]),[R,P]=b.useState(!1),[B,j]=b.useState(0),[D,je]=b.useState(5),[ie,le]=b.useState(0),[ce,we]=b.useState(5);b.useEffect(()=>{de(),ve()},[]);const de=async()=>{try{U(!0);const{data:{user:s}}=await f.auth.getUser();if(!s)throw new Error("User not authenticated");const[n,o,c,g,x]=await Promise.all([f.from("auto_approval_settings").select("*").order("created_at",{ascending:!1}),f.from("auto_approval_logs").select("*").order("created_at",{ascending:!1}),f.from("equipment").select("id, name, lab_id").eq("status","operational"),f.from("lab").select("id, name"),f.from("users").select("*")]);if(n.error)throw n.error;if(o.error)throw o.error;if(c.error)throw c.error;if(g.error)throw g.error;if(x.error)throw x.error;const r=o.data.map(t=>{const d=n.data.find(i=>i.id===t.setting_id);let p="Unknown Target";if(d){if(d.target_type==="system")p="System";else if(d.target_type==="lab"){const i=g.data.find(m=>m.id===d.target_id);p=i?i.name:"Unknown Lab"}else if(d.target_type==="equipment"){const i=c.data.find(m=>m.id===d.target_id);p=i?i.name:"Unknown Equipment"}}const I=x.data.find(i=>i.id===t.performed_by),Y=I?I.email:"Unknown User",Q=I?I.role:"Unknown User";return{...t,target_name:p,performed_by_email:Y,performed_by_role:Q}});_(n.data),S(r),A(c.data),C(g.data),F(x.data||[]);const a=n.data.find(t=>t.target_type==="system");P(a?.enabled||!1)}catch(s){q(s.message)}finally{U(!1)}},Se=s=>{const n=["id","target_type","enabled","created_by","last_modified_by","created_at","updated_at"];for(const o of n)if(!(o in s))throw new Error(`Missing required field '${o}' in AutoApprovalSetting`);return s},ve=()=>{const s=(r,a)=>r.some(t=>t.id===a.id)?r.map(t=>t.id===a.id?a:t):[a,...r],n=f.channel("auto-approval-settings-changes").on("postgres_changes",{event:"*",schema:"public",table:"auto_approval_settings"},r=>{_(a=>{if(r.eventType==="INSERT"||r.eventType==="UPDATE")try{const t=Se(r.new);return t.target_type==="system"&&P(t.enabled),s(a,t)}catch(t){return console.error("Invalid payload:",t),a}else if(r.eventType==="DELETE")return a.filter(t=>t.id!==r.old.id);return a})}).subscribe(),o=f.channel("auto-approval-logs-changes").on("postgres_changes",{event:"INSERT",schema:"public",table:"auto_approval_logs"},async r=>{console.log("New log entry received:",r);try{const a=r.new;let t=h.find(i=>i.id===a.setting_id);if(!t){console.warn("Setting not found locally, fetching from database...");const{data:i,error:m}=await f.from("auto_approval_settings").select("*").eq("id",a.setting_id).single();if(m){console.error("Error fetching setting:",m);return}t=i,_(w=>s(w,i))}let d="Unknown Target";if(t){if(t.target_type==="system")d="System";else if(t.target_type==="lab"){let i=v.find(m=>m.id===t.target_id);if(!i){console.warn("Lab not found locally, fetching from database...");const{data:m,error:w}=await f.from("lab").select("*").eq("id",t.target_id).single();w?console.error("Error fetching lab:",w):(i=m,C(Z=>s(Z,m)))}d=i?i.name:"Unknown Lab"}else if(t.target_type==="equipment"){let i=k.find(m=>m.id===t.target_id);if(!i){console.warn("Equipment not found locally, fetching from database...");const{data:m,error:w}=await f.from("equipment").select("*").eq("id",t.target_id).single();w?console.error("Error fetching equipment:",w):(i=m,A(Z=>s(Z,m)))}d=i?i.name:"Unknown Equipment"}}let p=$.find(i=>i.id===a.performed_by);if(!p){console.warn("User not found locally, fetching from database...");const{data:i,error:m}=await f.from("users").select("*").eq("id",a.performed_by).single();m?console.error("Error fetching user:",m):(p=i,F(w=>s(w,i)))}const I=p?p.email:"Unknown User",Y=p?p.role:"Unknown Role",Q={...a,target_name:d,performed_by_email:I,performed_by_role:Y};console.log("Enriched log:",Q),S(i=>[Q,...i])}catch(a){console.error("Error enriching log:",a)}}).subscribe(),c=f.channel("users-changes").on("postgres_changes",{event:"*",schema:"public",table:"users"},r=>{F(a=>r.eventType==="INSERT"?s(a,r.new):r.eventType==="UPDATE"?a.map(t=>t.id===r.old.id?r.new:t):r.eventType==="DELETE"?a.filter(t=>t.id!==r.old.id):a)}).subscribe(),g=f.channel("labs-changes").on("postgres_changes",{event:"*",schema:"public",table:"lab"},r=>{C(a=>r.eventType==="INSERT"?s(a,r.new):r.eventType==="UPDATE"?a.map(t=>t.id===r.old.id?r.new:t):r.eventType==="DELETE"?a.filter(t=>t.id!==r.old.id):a)}).subscribe(),x=f.channel("equipment-changes").on("postgres_changes",{event:"*",schema:"public",table:"equipment"},r=>{A(a=>r.eventType==="INSERT"?s(a,r.new):r.eventType==="UPDATE"?a.map(t=>t.id===r.old.id?r.new:t):r.eventType==="DELETE"?a.filter(t=>t.id!==r.old.id):a)}).subscribe();return()=>{n.unsubscribe(),o.unsubscribe(),c.unsubscribe(),g.unsubscribe(),x.unsubscribe()}},Pe=async(s,n,o,c)=>{try{const g=$.map(r=>({id:crypto.randomUUID(),user_id:r.id,created_by:s,title:n,message:o,type:c,read:!1,created_at:new Date().toISOString()})),{error:x}=await f.from("notifications").insert(g);if(x)throw x}catch(g){console.error("Error sending notifications:",g.message)}},X=async(s,n,o)=>{if(!u){console.error("User is not authenticated");return}try{s==="system"&&P(t=>!t),_(t=>{const d=t.find(p=>p.target_type===s&&p.target_id===n);return d?t.map(p=>p.id===d.id?{...p,enabled:!o,updated_at:new Date().toISOString()}:p):[{id:crypto.randomUUID(),target_type:s,target_id:s==="system"?null:n||"",enabled:!o,created_by:u.id,last_modified_by:u.id,created_at:new Date().toISOString(),updated_at:new Date().toISOString()},...t]});const c=h.find(t=>t.target_type===s&&t.target_id===n);let g=c?.id;if(c){const{error:t}=await f.from("auto_approval_settings").update({enabled:!o,last_modified_by:u.id,updated_at:new Date().toISOString()}).eq("id",c.id);if(t)throw t}else{const{data:t,error:d}=await f.from("auto_approval_settings").insert([{target_type:s,target_id:s==="system"?null:n||"",enabled:!o,created_by:u.id,last_modified_by:u.id,created_at:new Date().toISOString(),updated_at:new Date().toISOString()}]).select();if(d)throw d;g=t?.[0]?.id}if(g){const{error:t}=await f.from("auto_approval_logs").insert([{setting_id:g,action:o?"disabled":"enabled",performed_by:u.id}]);if(t)throw t}let x="",r="";const a="System";if(s==="system")x=o?"System-wide Auto-Approval Deactivated":"System-wide Auto-Approval Activated",r=o?"Auto-approval for all equipment reservations has been disabled.":"All equipment reservations are now auto-approved.";else if(s==="lab"){const t=v.find(d=>d.id===n);x=o?`Auto-Approval Deactivated for Lab: ${t?.name||"Unknown Lab"}`:`Auto-Approval Activated for Lab: ${t?.name||"Unknown Lab"}`,r=o?"Auto-approval for equipment in this lab has been disabled.":"All equipment in this lab is now auto-approved for reservations."}else if(s==="equipment"){const t=k.find(d=>d.id===n);x=o?`Auto-Approval Deactivated for Equipment: ${t?.name||"Unknown Equipment"}`:`Auto-Approval Activated for Equipment: ${t?.name||"Unknown Equipment"}`,r=o?"Auto-approval for this equipment has been disabled.":"This equipment is now auto-approved for reservations."}await Pe(a,x,r,"info"),K(`Auto-approval ${o?"disabled":"enabled"} successfully`),W(!0)}catch(c){console.error("Error toggling auto-approval:",c.message),q(c.message),s==="system"&&P(g=>!g),de()}},ue=(s,n)=>h.filter(c=>c.target_type===s&&c.target_id===(n||null)).sort((c,g)=>new Date(g.created_at).getTime()-new Date(c.created_at).getTime())[0]?.enabled||!1,Ee=(s,n)=>{j(n)},qe=s=>{je(parseInt(s.target.value,10)),j(0)},Ae=(s,n)=>{le(n)},Ce=s=>{we(parseInt(s.target.value,10)),le(0)},pe=(s,n,o)=>s.slice(n*o,n*o+o),me=(s,n,o)=>s.slice(n*o,n*o+o);return y?e.jsx(V,{sx:{display:"flex",justifyContent:"center",p:3},children:e.jsx($e,{})}):M?e.jsx(Fe,{severity:"error",sx:{m:2},children:M}):e.jsxs(V,{sx:{p:3},children:[e.jsx(L,{variant:"h5",gutterBottom:!0,children:"Auto-Approval Settings"}),e.jsx(ee,{sx:{p:3,mb:3},children:e.jsx(Ye,{control:e.jsx(te,{checked:R,onChange:()=>X("system",null,R)}),label:e.jsxs(V,{children:[e.jsx(L,{variant:"h6",children:"System-wide Auto-Approval"}),e.jsx(L,{variant:"body2",color:"text.secondary",children:"Enable automatic approval for all equipment reservations"})]})})}),e.jsx(L,{variant:"h6",gutterBottom:!0,sx:{mt:4},children:"Laboratory Settings"}),e.jsx(ge,{component:ee,children:e.jsxs(se,{children:[e.jsx(re,{children:e.jsxs(E,{children:[e.jsx(l,{children:"Laboratory"}),e.jsx(l,{children:"Auto-Approval Status"}),e.jsx(l,{children:"Last Modified"}),e.jsx(l,{children:"Actions"})]})}),e.jsx(ne,{children:me.length>0&&me(v,B,D).map(s=>{const n=ue("lab",s.id);return e.jsxs(E,{children:[e.jsx(l,{children:s.name}),e.jsx(l,{children:e.jsx(ae,{label:n?"Enabled":"Disabled",color:n?"success":"default",size:"small"})}),e.jsx(l,{children:oe(new Date,"PPp")}),e.jsx(l,{children:e.jsx(te,{checked:n,onChange:()=>X("lab",s.id,n)})})]},s.id)})}),e.jsx(he,{children:e.jsx(E,{children:e.jsx(xe,{rowsPerPageOptions:[5,10,25],colSpan:4,count:v.length,rowsPerPage:D,page:B,onPageChange:Ee,onRowsPerPageChange:qe})})})]})}),e.jsx(L,{variant:"h6",gutterBottom:!0,sx:{mt:4},children:"Equipment Settings"}),e.jsx(ge,{component:ee,children:e.jsxs(se,{children:[e.jsx(re,{children:e.jsxs(E,{children:[e.jsx(l,{children:"Equipment"}),e.jsx(l,{children:"Laboratory"}),e.jsx(l,{children:"Auto-Approval Status"}),e.jsx(l,{children:"Last Modified"}),e.jsx(l,{children:"Actions"})]})}),e.jsx(ne,{children:pe.length>0&&pe(k,ie,ce).map(s=>{const n=ue("equipment",s.id),o=v.find(c=>c.id===s.lab_id);return e.jsxs(E,{children:[e.jsx(l,{children:s.name}),e.jsx(l,{children:o?.name||"Unknown"}),e.jsx(l,{children:e.jsx(ae,{label:n?"Enabled":"Disabled",color:n?"success":"default",size:"small"})}),e.jsx(l,{children:oe(new Date,"PPp")}),e.jsx(l,{children:e.jsx(te,{checked:n,onChange:()=>X("equipment",s.id,n)})})]},s.id)})}),e.jsx(he,{children:e.jsx(E,{children:e.jsx(xe,{rowsPerPageOptions:[5,10,25],colSpan:5,count:k.length,rowsPerPage:ce,page:ie,onPageChange:Ae,onRowsPerPageChange:Ce})})})]})}),e.jsx(V,{sx:{mt:3,display:"flex",justifyContent:"flex-end"},children:e.jsx(be,{startIcon:e.jsx(Qe,{}),onClick:()=>N(!0),children:"View Audit Logs"})}),e.jsxs(Oe,{open:H,onClose:()=>N(!1),maxWidth:"md",fullWidth:!0,children:[e.jsx(Me,{children:"Auto-Approval Audit Logs"}),e.jsx(ze,{children:e.jsxs(se,{children:[e.jsx(re,{children:e.jsxs(E,{children:[e.jsx(l,{children:"Date"}),e.jsx(l,{children:"Action"}),e.jsx(l,{children:"Target"}),e.jsx(l,{children:"Performed By"})]})}),e.jsx(ne,{children:T.map(s=>e.jsxs(E,{children:[e.jsx(l,{children:oe(new Date(s.created_at),"PPp")}),e.jsx(l,{children:e.jsx(ae,{label:s.action,color:s.action==="enabled"?"success":"default",size:"small"})}),e.jsx(l,{children:s.target_name}),e.jsxs(l,{children:[s.performed_by_email,"(",s.performed_by_role,")"]})]},s.id))})]})}),e.jsx(We,{children:e.jsx(be,{onClick:()=>N(!1),children:"Close"})})]}),e.jsx(He,{open:z,autoHideDuration:6e3,onClose:()=>W(!1),message:J})]})}export{rt as default};
//# sourceMappingURL=AutoApprovalSettings-jQeKaInu.js.map
